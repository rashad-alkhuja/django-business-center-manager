<!-- templates/accounting/cheque_dashboard.html -->
{% extends 'offices/base_with_nav.html' %}
{% load static %}

{% block title %}Active Cheques Dashboard{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .metric-val {
        font-size: 2rem;
        font-weight: 700;
        margin: 15px 0 0;
    }

    .metric-currency {
        font-size: 1rem;
        color: #95a5a6;
    }
</style>

<div class="booking-container">
    <div class="header-actions"
        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1 style="font-size: 2rem; color: #2c3e50;">Active Cheques Dashboard</h1>

        <div style="display: flex; align-items: center; gap: 10px;">
            <!-- Year Filter Form -->
            <form method="get" action="" style="margin-right: 15px;">
                <label for="year-select" style="font-weight: bold; margin-right: 5px; color: #2c3e50;">Year:</label>
                <select id="year-select" name="year" onchange="this.form.submit()"
                    style="padding: 8px 12px; border-radius: 5px; border: 1px solid #bdc3c7; font-size: 1rem; cursor: pointer;">
                    {% for year in available_years %}
                    <option value="{{ year }}" {% if year == selected_year %} selected {% endif %}>
                        {{ year }}
                    </option>
                    {% endfor %}
                </select>
            </form>

            <a href="{% url 'download-report' %}?year={{ selected_year }}" class="btn-primary"
                style="background-color: #3498db; border: none; padding: 10px 20px; border-radius: 5px; color: white; text-decoration: none; font-weight: bold;">Download
                Report</a>
            <a href="{% url 'dashboard' %}" class="btn-secondary"
                style="background-color: #95a5a6; border: none; padding: 10px 20px; border-radius: 5px; color: white; text-decoration: none;">Back
                to Dashboard</a>
        </div>
    </div>

    <!-- Summary Metrics -->
    <div class="metrics-grid"
        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
        <!-- Total Rented Value -->
        <div class="metric-card"
            style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-left: 5px solid #3498db;">
            <h3
                style="margin-top: 0; color: #7f8c8d; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px;">
                Total Rented Value</h3>
            <p class="metric-val" style="color: #2c3e50;">
                {{ total_rented_value|floatformat:2 }} <span class="metric-currency">AED</span>
            </p>
        </div>

        <!-- Upcoming Cash Flow -->
        <div class="metric-card"
            style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-left: 5px solid #2ecc71;">
            <h3
                style="margin-top: 0; color: #7f8c8d; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px;">
                Cheque Cash Flow ({{ selected_year }})</h3>
            <p class="metric-val" style="color: #27ae60;">
                {{ upcoming_cashflow|floatformat:2 }} <span class="metric-currency">AED</span>
            </p>
            <small style="color: #95a5a6; display: block; margin-top: 5px;">(Pending & Due)</small>
        </div>

        <!-- Occupancy Rate -->
        <div class="metric-card"
            style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-left: 5px solid #9b59b6;">
            <h3
                style="margin-top: 0; color: #7f8c8d; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px;">
                Occupancy Rate</h3>
            <p class="metric-val" style="color: #8e44ad;">
                {{ occupancy_rate }}%
            </p>
            <small style="color: #95a5a6; display: block; margin-top: 5px;">
                {{ rented_offices_count }} of {{ total_offices_count }} Offices Rented
            </small>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="charts-grid" style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px; margin-bottom: 30px;">
        <div class="chart-card"
            style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
            <h3 style="margin-top: 0; color: #2c3e50; font-size: 1.1rem; margin-bottom: 15px;">Cheque Status
                Distribution ({{ selected_year }})</h3>
            <div style="height: 250px; position: relative;">
                <canvas id="statusChart"></canvas>
            </div>
        </div>
        <div class="chart-card"
            style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
            <h3 style="margin-top: 0; color: #2c3e50; font-size: 1.1rem; margin-bottom: 15px;">Cash Flow ({{ selected_year }})</h3>
                
            <div style="height: 250px; position: relative;">
                <canvas id="cashflowChart"></canvas>
            </div>
        </div>
    </div>

    <div class="table-card"
        style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
        <h3
            style="margin-top: 0; color: #2c3e50; font-size: 1.2rem; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
            Detailed Cheque List ({{ selected_year }})</h3>
        <table class="styled-table" style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background-color: #f8f9fa; text-align: left;">
                    <th style="padding: 12px 15px; color: #7f8c8d; font-weight: 600;">Office</th>
                    <th style="padding: 12px 15px; color: #7f8c8d; font-weight: 600;">Due Date</th>
                    <th style="padding: 12px 15px; color: #7f8c8d; font-weight: 600;">Amount</th>
                    <th style="padding: 12px 15px; color: #7f8c8d; font-weight: 600;">Current Status</th>
                    <th style="padding: 12px 15px; color: #7f8c8d; font-weight: 600;">Action</th>
                </tr>
            </thead>
            <tbody>
                {% for cheque in active_cheques %}
                <tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 12px 15px; font-weight: 500;">{{ cheque.lease.office }}</td>
                    <td style="padding: 12px 15px; color: #666;">{{ cheque.due_date|date:"M d, Y" }}</td>
                    <td style="padding: 12px 15px; font-weight: bold; color: #2c3e50;">{{ cheque.amount|floatformat:2 }}
                    </td>
                    <td style="padding: 12px 15px;">
                        <span class="status-badge status-{{ cheque.status|lower }}" style="padding: 5px 10px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; 
                                  {% if cheque.status == 'Pending' %}background: #fff3cd; color: #856404;
                                  {% elif cheque.status == 'Due' %}background: #d4edda; color: #155724;
                                  {% elif cheque.status == 'Deposited' %}background: #d1ecf1; color: #0c5460;
                                  {% elif cheque.status == 'Bounced' %}background: #f8d7da; color: #721c24;
                                  {% else %}background: #e2e3e5; color: #383d41;{% endif %}
                                  ">
                            {{ cheque.status }}
                        </span>
                    </td>
                    <td style="padding: 12px 15px;">
                        <form action="{% url 'update-cheque-status' cheque.pk %}" method="post">
                            {% csrf_token %}
                            <select name="status" onchange="this.form.submit()"
                                style="padding: 5px; border-radius: 4px; border: 1px solid #ddd; background: #fff;">
                                <option value="{{ cheque.status }}" selected hidden>Update Status</option>
                                <option value="Pending">Pending</option>
                                <option value="Deposited">Deposited</option>
                                <option value="Cleared">Cleared</option>
                                <option value="Bounced">Bounced</option>
                            </select>
                        </form>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" style="padding: 20px; text-align: center; color: #999;">There are no active cheques
                        to display.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    // Safe parsing of JSON data passed from view
    const statusData = JSON.parse('{{ status_data_json|escapejs }}');
    const cashflowLabels = JSON.parse('{{ cashflow_labels_json|escapejs }}');
    const cashflowData = JSON.parse('{{ cashflow_data_json|escapejs }}');

    // color palette
    const colors = {
        'Pending': '#f1c40f',
        'Due': '#e67e22',
        'Deposited': '#3498db',
        'Cleared': '#2ecc71',
        'Bounced': '#e74c3c'
    };

    // 1. Status Pie Chart
    const ctxStatus = document.getElementById('statusChart').getContext('2d');
    new Chart(ctxStatus, {
        type: 'doughnut',
        data: {
            labels: Object.keys(statusData),
            datasets: [{
                data: Object.values(statusData),
                backgroundColor: Object.keys(statusData).map(status => colors[status] || '#95a5a6'),
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: { boxWidth: 12, usePointStyle: true }
                }
            }
        }
    });

    // 2. Cashflow Bar Chart
    const ctxCashflow = document.getElementById('cashflowChart').getContext('2d');
    new Chart(ctxCashflow, {
        type: 'bar',
        data: {
            labels: cashflowLabels,
            datasets: [{
                label: 'Projected Inflow (AED)',
                data: cashflowData,
                backgroundColor: '#2ecc71',
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { display: true, drawBorder: false }
                },
                x: {
                    grid: { display: false }
                }
            }
        }
    });
</script>
{% endblock %}